networks:
  graylog:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
  opensearch_data:
    driver: local
  graylog_data:
    driver: local

services:
  # MongoDB - Graylog metadata and configuration
  mongodb:
    image: mongo:7.0
    container_name: graylog_mongodb
    restart: always
    networks:
      - graylog
    volumes:
      - mongodb_data:/data/db
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGODB_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_PASSWORD}
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # No exposed ports - accessible only within the graylog network

  # OpenSearch - log storage
  opensearch:
    image: opensearchproject/opensearch:2.18.0
    container_name: graylog_opensearch
    restart: always
    networks:
      - graylog
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    environment:
      - cluster.name=graylog
      - node.name=opensearch-node1
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms${OPENSEARCH_HEAP_SIZE} -Xmx${OPENSEARCH_HEAP_SIZE}"
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_PASSWORD}
      - plugins.security.disabled=true
      - action.auto_create_index=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 2G
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    # No exposed ports - accessible only within the graylog network

  # Graylog Server
  graylog:
    image: graylog/graylog:7.0
    container_name: graylog_server
    restart: always
    networks:
      - graylog
    depends_on:
      - mongodb
      - opensearch
    ports:
      # Web interface and REST API
      - "${GRAYLOG_HTTP_PORT}:9000"
      # GELF UDP (for Quantus nodes)
      - "${GRAYLOG_GELF_UDP_PORT}:12201/udp"
      # Prometheus metrics
      - "9833:9833"
    volumes:
      - graylog_data:/usr/share/graylog/data
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 2G
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/api/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    environment:
      # Basic configuration
      - GRAYLOG_NODE_ID_FILE=/usr/share/graylog/data/config/node-id
      - GRAYLOG_HTTP_BIND_ADDRESS=0.0.0.0:9000
      - GRAYLOG_HTTP_EXTERNAL_URI=${GRAYLOG_HTTP_EXTERNAL_URI}
      
      # MongoDB connection
      - GRAYLOG_MONGODB_URI=mongodb://${MONGODB_USER}:${MONGODB_PASSWORD}@mongodb:27017/graylog?authSource=admin
      
      # OpenSearch connection
      - GRAYLOG_ELASTICSEARCH_HOSTS=http://opensearch:9200
      
      # Passwords and security
      - GRAYLOG_PASSWORD_SECRET=${GRAYLOG_PASSWORD_SECRET}
      - GRAYLOG_ROOT_PASSWORD_SHA2=${GRAYLOG_ROOT_PASSWORD_SHA2}
      - GRAYLOG_ROOT_USERNAME=${GRAYLOG_ROOT_USERNAME}
      
      # Timezone
      - GRAYLOG_ROOT_TIMEZONE=${GRAYLOG_TIMEZONE}
      
      # Production settings
      - GRAYLOG_IS_MASTER=true
      - GRAYLOG_HTTP_PUBLISH_URI=${GRAYLOG_HTTP_EXTERNAL_URI}
      - GRAYLOG_HTTP_ENABLE_CORS=false
      - GRAYLOG_HTTP_ENABLE_GZIP=true
      - GRAYLOG_HTTP_THREAD_POOL_SIZE=200
      - GRAYLOG_PROCESSBUFFER_PROCESSORS=5
      - GRAYLOG_OUTPUTBUFFER_PROCESSORS=3
      - GRAYLOG_OUTPUT_BATCH_SIZE=500
      - GRAYLOG_RING_SIZE=65536
      - GRAYLOG_ASYNC_EVENTBUS_PROCESSORS=2
      
      # Prometheus metrics
      - GRAYLOG_PROMETHEUS_EXPORTER_ENABLED=true
      - GRAYLOG_PROMETHEUS_EXPORTER_BIND_ADDRESS=0.0.0.0:9833
      
      # Email configuration (optional)
      - GRAYLOG_TRANSPORT_EMAIL_ENABLED=${GRAYLOG_EMAIL_ENABLED}
      - GRAYLOG_TRANSPORT_EMAIL_HOSTNAME=${GRAYLOG_EMAIL_HOSTNAME}
      - GRAYLOG_TRANSPORT_EMAIL_PORT=${GRAYLOG_EMAIL_PORT}
      - GRAYLOG_TRANSPORT_EMAIL_USE_AUTH=${GRAYLOG_EMAIL_USE_AUTH}
      - GRAYLOG_TRANSPORT_EMAIL_AUTH_USERNAME=${GRAYLOG_EMAIL_USERNAME}
      - GRAYLOG_TRANSPORT_EMAIL_AUTH_PASSWORD=${GRAYLOG_EMAIL_PASSWORD}
      - GRAYLOG_TRANSPORT_EMAIL_USE_TLS=${GRAYLOG_EMAIL_USE_TLS}
      - GRAYLOG_TRANSPORT_EMAIL_USE_SSL=${GRAYLOG_EMAIL_USE_SSL}
      - GRAYLOG_TRANSPORT_EMAIL_FROM_EMAIL=${GRAYLOG_EMAIL_FROM}

  # Graylog Init - Auto-import inputs on startup
  graylog-init:
    image: alpine:latest
    container_name: graylog_init
    restart: "no"
    networks:
      - graylog
    depends_on:
      graylog:
        condition: service_healthy
    volumes:
      - ./graylog-inputs.json:/inputs.json:ro
    environment:
      - GRAYLOG_API=http://graylog:9000/api
      - GRAYLOG_USER=${GRAYLOG_ROOT_USERNAME}
      - GRAYLOG_PASSWORD=${GRAYLOG_ROOT_PASSWORD}
    command:
      - /bin/sh
      - -c
      - |
        apk add --no-cache curl jq
        echo 'Waiting for Graylog API to be fully ready...'
        
        # Wait for API to respond (with timeout)
        COUNTER=0
        MAX_TRIES=60
        until curl -s -f -u "$$GRAYLOG_USER:$$GRAYLOG_PASSWORD" "$$GRAYLOG_API/system/lbstatus" > /dev/null 2>&1; do
          COUNTER=$$((COUNTER + 1))
          if [ $$COUNTER -gt $$MAX_TRIES ]; then
            echo "ERROR: Graylog API did not become ready in time"
            exit 1
          fi
          echo "Waiting for API... attempt $$COUNTER/$$MAX_TRIES"
          sleep 5
        done
        
        # Extra wait to ensure Graylog is fully initialized
        echo 'API responding, waiting extra 30 seconds for full initialization...'
        sleep 30
        
        echo 'Importing inputs...'
        jq -c '.inputs[]' /inputs.json | while read -r input; do
          TITLE=$$(echo "$$input" | jq -r '.title')
          echo "Creating input: $$TITLE"
          
          RESPONSE=$$(curl -s -w "\n%{http_code}" -X POST "$$GRAYLOG_API/system/inputs" \
            -H "Content-Type: application/json" \
            -H "X-Requested-By: cli" \
            -u "$$GRAYLOG_USER:$$GRAYLOG_PASSWORD" \
            -d "$$input")
          
          HTTP_CODE=$$(echo "$$RESPONSE" | tail -n1)
          BODY=$$(echo "$$RESPONSE" | head -n-1)
          
          if [ "$$HTTP_CODE" = "201" ]; then
            echo "✓ Successfully created: $$TITLE"
          elif [ "$$HTTP_CODE" = "400" ] && echo "$$BODY" | grep -q "already exists"; then
            echo "ℹ Input already exists: $$TITLE"
          else
            echo "✗ Failed to create $$TITLE (HTTP $$HTTP_CODE)"
            echo "Response: $$BODY"
          fi
        done
        
        echo '✓ Input import completed!'
